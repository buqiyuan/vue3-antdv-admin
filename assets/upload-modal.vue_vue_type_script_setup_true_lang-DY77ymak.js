import{f as y}from"./dateUtil-C_wTM_e-.js";import{e as s,a5 as O,ep as S,K as m,d as k,r as C,c as F,B as P,q as T,v as D,F as p,H as w,N,O as L,at as z}from"./index-Clv9zNM3.js";import{I as R}from"./index-CxEAG5-f.js";import{T as f}from"./index-D0onqgqk.js";import{P as B}from"./index-C2Yf5-vJ.js";import{_ as G}from"./index.vue_vue_type_style_index_0_lang-CFCPI4h7.js";import{u as $}from"./dynamic-table-ewKYMhCK.js";import"./ApiSelect.vue_vue_type_script_setup_true_lang-DvgRuKxQ.js";import"./dayjs.min-BYaCBWoX.js";import{_ as j}from"./index-BqBMX9-S.js";import{_ as K}from"./index-DDNVrX_N.js";import{_ as M}from"./index-6_t5xb7Y.js";let o=function(e){return e.SUCCESS="success",e.ERROR="error",e.UPLOADING="uploading",e}({});const oe=[{title:"文件名",dataIndex:"name",width:150,ellipsis:!0,customRender({record:e}){return s(O,null,{title:()=>e.path,default:()=>s("a",{href:S+e.path,target:"_blank"},[e.name])})}},{title:"预览图",dataIndex:"path",width:150,customRender({record:e}){return s(R,{src:S+e.path},null)}},{title:"文件后缀",dataIndex:"extName",width:80},{title:"类别",dataIndex:"type",width:80},{title:"大小",dataIndex:"size",width:80,customRender:({record:e})=>s(f,{color:"blue"},{default:()=>[e.size]})},{title:"上传者",dataIndex:"username",width:120},{title:"创建时间",dataIndex:"createdAt",width:160,customRender:({record:e})=>y(e.createdAt)}],V=[{dataIndex:"thumbUrl",title:"缩略图",width:100,customRender:({record:e})=>{const{thumbUrl:u}=e;return u&&s(R,{src:u},null)}},{dataIndex:"name",title:"文件名",align:"left",customRender:({text:e,record:u})=>{const{percent:_,status:d}=u||{};let l="normal";return d===o.ERROR?l="exception":d===o.UPLOADING?l="active":d===o.SUCCESS&&(l="success"),s("div",null,[s("p",{class:"truncate mb-1 max-w-[280px]",title:e},[e]),s(B,{percent:_,size:"small",status:l},null)])}},{dataIndex:"size",title:"文件大小",width:100,customRender:({text:e=0})=>e&&`${(e/1024).toFixed(2)}KB`},{dataIndex:"status",title:"状态",width:100,customRender:({text:e})=>e===o.SUCCESS?s(f,{color:"green"},{default:()=>[m("上传成功")]}):e===o.ERROR?s(f,{color:"red"},{default:()=>[m("上传失败")]}):e===o.UPLOADING?s(f,{color:"blue"},{default:()=>[m("上传中")]}):e||"待上传"}],ne=[{field:"name",label:"名称",component:"Input",colProps:{span:8}}],le=k({__name:"upload-modal",emits:["uploadSuccess"],setup(e,{emit:u}){const _=u,[d]=$(),l=C(!1),r=C([]),v=F(()=>!r.value.some(a=>a.status!==o.SUCCESS)),I=a=>{const{promise:t,resolve:n,reject:c}=Promise.withResolvers(),i=new FileReader;return i.onload=()=>{n(i.result)},i.onerror=b=>{c(b)},i.readAsDataURL(a),t},U=()=>{r.value.some(t=>t.status===o.SUCCESS)&&_("uploadSuccess"),r.value=[]},x=async()=>{const a=r.value.filter(t=>t.status!==o.SUCCESS);await Promise.all(a.map(async t=>{try{await z.toolsUpload.uploadUpload({file:t.file},void 0,{onUploadProgress(n){const c=n.loaded/n.total*100|0;t.percent=c,t.status=o.UPLOADING}}),t.status=o.SUCCESS}catch(n){t.status=o.ERROR}}))},E=async a=>{if(a.size/1024/1024>2)L.error("单个文件不超过2MB");else{const t={file:a,uid:a.uid,name:a.name,size:a.size,status:"",percent:0,thumbUrl:await I(a)};r.value.push(t)}return!1},g=a=>{r.value=r.value.filter(t=>t.uid!==a.uid)},A=[...V,{width:120,title:"操作",dataIndex:"ACTION",fixed:!1,actions:({record:a})=>[{label:"删除",color:"red",onClick:()=>g(a)}]}];return(a,t)=>{const n=P("a-button"),c=K,i=M,b=j;return D(),T(N,null,[s(n,{type:"primary",disabled:!a.$auth("upload:upload"),onClick:t[0]||(t[0]=h=>l.value=!0)},{default:p(()=>t[2]||(t[2]=[m(" 上传 ")])),_:1,__:[2]},8,["disabled"]),s(w(G),{open:l.value,"onUpdate:open":t[1]||(t[1]=h=>l.value=h),title:"上传",width:800,"ok-text":"开始上传","ok-button-props":{disabled:v.value},onOk:x,onCancel:U},{default:p(()=>[s(b,{justify:"space-between",align:"center"},{default:p(()=>[s(c,{message:"单个文件不超过2MB，最多只能上传10个文件",type:"info","show-icon":""}),s(i,{multiple:!0,"before-upload":E,"show-upload-list":!1},{default:p(()=>[s(n,{type:"primary"},{default:p(()=>t[3]||(t[3]=[m(" 选择文件 ")])),_:1,__:[3]})]),_:1})]),_:1}),s(w(d),{search:!1,"data-source":r.value,columns:A},null,8,["data-source"])]),_:1},8,["open","ok-button-props"])],64)}}});export{le as _,oe as b,ne as s};
